<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.0.0/dist/peerjs.min.js"></script>
    <title>ВидеоЗвонок</title>
</head>

<body>
    <p id="myID">Мой ID:</p>
    <input id="otherPeerId" type="text" placeholder="ID партнера...">
    <button onclick="callToNode(document.getElementById('otherPeerId').value)">Позвонить</button>
    <div id="callInfo">Информация о звонке</div>

    <video id="myVideo" width="400px" height="400px"></video>
    <video id="remVideo" width="400px" height="400px"></video>
</body>


<script>
    let peer = new Peer()
    console.log('123')
    peer.on('open', function (peerID) {
        document.querySelector('#myID').innerHTML += ' ' + peerID
    })

    let peerCall
    peer.on('call', function (call) {
        peerCall = call
        console.log('call = ' + call)
        console.log('peercall = ' + peerCall)
        document.querySelector('#callInfo').innerHTML = "Входящий звонок <button onclick='callanswer()' >Принять</button><button onclick='callcancel()' >Отклонить</button>";
    })
    function callanswer() {
        console.log(peerCall.answer)
        navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(function (mediaStream) {
            var video = document.getElementById('myVideo');
            peercall.answer(mediaStream); // отвечаем на звонок и передаем свой медиапоток собеседнику
            console.log('peercall = ' + peerCall)
            //peercall.on ('close', onCallClose); //можно обработать закрытие-обрыв звонка
            video.srcObject = mediaStream; //помещаем собственный медиапоток в объект видео (чтоб видеть себя)
            document.getElementById('callInfo').innerHTML = "Звонок начат... <button onclick='callclose()' >Завершить звонок</button>"; //информируем, что звонок начат, и выводим кнопку Завершить
            video.onloadedmetadata = function (e) {//запускаем воспроизведение, когда объект загружен
                video.play();
            };
            setTimeout(function () {
                //входящий стрим помещаем в объект видео для отображения
                document.getElementById('remVideo').srcObject = peercall.remoteStream;
                document.getElementById('remVideo').onloadedmetadata = function (e) {
                    // и запускаем воспроизведение когда объект загружен
                    document.getElementById('remVideo').play();
                };
            }, 1500);

        })
    }


    function callToNode(peerId) { //вызов
        navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(function (mediaStream) {
            // console.log(navigator.mediaDevices)
            var video = document.getElementById('myVideo');
            peercall = peer.call(peerId, mediaStream); //звоним, указав peerId-партнера и передав свой mediaStream
            peercall.on('stream', function (stream) { //нам ответили, получим стрим
                setTimeout(function () {
                    document.getElementById('remVideo').srcObject = peercall.remoteStream;
                    document.getElementById('remVideo').onloadedmetadata = function (e) {
                        document.getElementById('remVideo').play();
                    };
                }, 1500);
            });
            //  peercall.on('close', onCallClose);				  
            video.srcObject = mediaStream;
            video.onloadedmetadata = function (e) {
                video.play();
            };
        }).catch(function (err) { console.log(err.name + ": " + err.message); });
    }

</script>

</html>